var Slipshow=function(t){"use strict";class e extends HTMLImageElement{static get observedAttributes(){return["figure-name"]}constructor(){super(),void 0===this.internalStep&&(this.internalStep=0),this.img=[],this.maxStep=0,this.figureName=this.getAttribute("figure-name"),this.promise=this.preloadImages(0).then(()=>{this.updateSRC()})}preloadImage(t){return new Promise((e,i)=>{this.img[t]=new Image,this.img[t].onload=()=>e(),this.img[t].onerror=i,this.img[t].src=this.getURL(t)})}preloadImages(t){return new Promise((e,i)=>{this.preloadImage(t).then(()=>{this.preloadImages(t+1).then(()=>{e()})}).catch(()=>{this.maxStep=t-1,e()})})}connectedCallback(){}getURL(t){return"figures/"+this.figureName+"/"+this.figureName+"_"+t+".svg"}updateSRC(){this.src=this.getURL(this.figureStep)}set figureStep(t){this.promise=this.promise.then(()=>{t>this.maxStep?this.internalStep=this.maxStep:this.internalStep=t<0?0:t,this.updateSRC()})}get figureStep(){return this.internalStep}attributeChangedCallback(t,e,i){"figure-name"==t&&(this.figureName=i,this.promise=this.promise.then(()=>{this.preloadImages(0).then(()=>{this.updateSRC()})}))}nextFigure(){this.figuresStep++}}customElements.define("slip-figure",e,{extends:"img"});let i=(t,e,i)=>{i=i||"slip-slip",t.id||(t.id="_"+Math.random().toString(36).substr(2,15));let s=Array.from(t.querySelectorAll(e)),o=e.split(",").map(e=>"#"+t.id+" "+i+" "+e).join(),n=Array.from(t.querySelectorAll(o));return s.filter(t=>!n.includes(t))};function s(t){let e=t.cloneNode(!1);return t.childNodes.forEach(t=>{if(t.tagName&&"SLIP-SLIP"==t.tagName){let i=document.createElement(t.tagName);i.classList.add("toReplace"),e.appendChild(i)}else if(t.tagName&&"CANVAS"==t.tagName&&t.classList.contains("sketchpad")){let i=document.createElement(t.tagName);i.classList.add("toReplaceSketchpad"),e.appendChild(i)}else e.appendChild(s(t))}),e}function o(t,e,s){let o=i(t,".toReplace");e.forEach((t,e)=>{o[e].replaceWith(t)}),i(t,".toReplaceSketchpad")[0].replaceWith(s)}window.myQueryAll=i;var n=Object.freeze({__proto__:null,myQueryAll:i,cloneNoSubslip:s,replaceSubslips:o});function r(t){let e=t;this.getEngine=()=>this.engine,this.setEngine=t=>this.engine=t;let i=!0;this.activate=()=>{i=!0},this.deactivate=()=>{i=!1};let s=["k"],o=["m"],n=["o"],r=["l"],a=["i"],l=["p"],h=["z"],c=["Z"],u=["T"],d=["t"],p=["ArrowRight","ArrowDown"],g=["ArrowLeft","ArrowUp"],m=["r"],f=["f"],v=[],y=["w"],b=["W"],w=["h"],A=["H"],x=["x"],S=["#"],k=1;document.addEventListener("keypress",t=>{f.includes(t.key)&&i&&(k=(k+4)%30+1),m.includes(t.key)&&i&&e.getCurrentSlip().refresh(),y.includes(t.key)&&i&&e.setTool("drawing"),b.includes(t.key)&&i&&e.setTool("drawing-erase"),w.includes(t.key)&&i&&e.setTool("highlighting"),A.includes(t.key)&&i&&e.setTool("highlighting-erase"),x.includes(t.key)&&i&&e.setTool("no-tool"),S.includes(t.key)&&i&&(document.querySelectorAll("slip-slip").forEach(t=>{t.style.zIndex="-1"}),document.querySelectorAll(".background-canvas").forEach(t=>{t.style.zIndex="1"}))}),document.addEventListener("keydown",t=>{let m=e.getOpenWindowHeight(),f=e.getOpenWindowWidth();r.includes(t.key)&&i&&e.moveWindowRelative(0,k/m,0,0,.1),n.includes(t.key)&&i&&e.moveWindowRelative(0,-k/m,0,0,.1),s.includes(t.key)&&i&&e.moveWindowRelative(-k/f,0,0,0,.1),o.includes(t.key)&&i&&e.moveWindowRelative(k/f,0,0,0,.1),a.includes(t.key)&&i&&e.moveWindowRelative(0,0,0,1,.1),l.includes(t.key)&&i&&e.moveWindowRelative(0,0,0,-1,.1),h.includes(t.key)&&i&&e.moveWindowRelative(0,0,.01,0,.1),c.includes(t.key)&&i&&e.moveWindowRelative(0,0,-.01,0,.1),u.includes(t.key)&&i&&e.showToC(),d.includes(t.key)&&i&&(document.querySelector(".toc-slip").style.display="none"==document.querySelector(".toc-slip").style.display?"block":"none"),p.includes(t.key)&&i?(console.log(t),t.shiftKey?e.nextSlip():e.next()):g.includes(t.key)&&i?t.shiftKey?e.previousSlip():e.previous():v.includes(t.key)&&i&&e.pop()})}class a{constructor(t,e){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}}var l={Mouse:class extends a{constructor(){super(0,0),this.down=!1,this.previous=new a(0,0)}},Point:a};const h={floodFillInterval:100,maxLineThickness:50,minLineThickness:1};h.lineThicknessRange=h.maxLineThickness-h.minLineThickness,h.thicknessIncrement=.5,h.minSmoothingFactor=.87,h.initialSmoothingFactor=.85,h.weightSpread=10,h.initialThickness=2;var c=h;var u={AtramentEventTarget:class{constructor(){this.eventListeners=new Map}addEventListener(t,e){const i=this.eventListeners.get(t)||new Set;i.add(e),this.eventListeners.set(t,i)}removeEventListener(t,e){const i=this.eventListeners.get(t);i&&i.delete(e)}dispatchEvent(t,e){const i=this.eventListeners.get(t);i&&[...i].forEach(t=>t(e))}}};var d,p=(function(t,e){e.lineDistance=(t,e,i,s)=>{const o=Math.pow(i-t,2),n=Math.pow(s-e,2);return Math.sqrt(o+n)},e.hexToRgb=t=>{const e=t.match(/^#?([\da-f]{2})([\da-f]{2})([\da-f]{2})$/i);return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]},e.matchColor=(t,e,i,s,o)=>n=>{const r=t[n],a=t[n+1],l=t[n+2],h=t[n+3];return r===e&&a===i&&l===s&&h===o},e.colorPixel=(t,i,s,o,n,r)=>{const a=e.matchColor(t,...n);return e=>{t[e]=i,t[e+1]=s,t[e+2]=o,t[e+3]=r,a(e+4)||(t[e+4]=.01*t[e+4]+.99*i,t[e+4+1]=.01*t[e+4+1]+.99*s,t[e+4+2]=.01*t[e+4+2]+.99*o,t[e+4+3]=.01*t[e+4+3]+.99*r),a(e-4)||(t[e-4]=.01*t[e-4]+.99*i,t[e-4+1]=.01*t[e-4+1]+.99*s,t[e-4+2]=.01*t[e-4+2]+.99*o,t[e-4+3]=.01*t[e-4+3]+.99*r)}}}(d={exports:{}},d.exports),d.exports);p.lineDistance,p.hexToRgb,p.matchColor,p.colorPixel;const{Mouse:g,Point:m}=l,{AtramentEventTarget:f}=u,v="draw",y="erase",b="fill",w="disabled",A=[v,y];var x=class extends f{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("undefined"==typeof window)throw new Error("Looks like we're not running in a browser");if(super(),t instanceof window.Node&&"CANVAS"===t.tagName)this.canvas=t;else{if("string"!=typeof t)throw new Error("can't look for canvas based on '".concat(t,"'"));this.canvas=document.querySelector(t)}if(!this.canvas)throw new Error("canvas not found");this.canvas.width=e.width||this.canvas.width,this.canvas.height=e.height||this.canvas.height,this.mouse=new g;const i=t=>{t.cancelable&&t.preventDefault();const e=this.canvas.getBoundingClientRect(),i=t.changedTouches&&t.changedTouches[0]||t;let s=i.offsetX,o=i.offsetY;void 0===s&&(s=i.clientX-e.left),void 0===o&&(o=i.clientY-e.top);const{mouse:n}=this;if(n.down&&A.includes(this.mode)){const{x:t,y:e}=this.draw(s,o,n.previous.x,n.previous.y);this._dirty||this.mode!==v||s===n.x&&o===n.y||(this._dirty=!0,this.fireDirty()),n.set(s,o),n.previous.set(t,e)}else n.set(s,o)},s=t=>{if(t.cancelable&&t.preventDefault(),i(t),this.mode===b)return void this.fill();const{mouse:e}=this;e.previous.set(e.x,e.y),e.down=!0,this.beginStroke(e.previous.x,e.previous.y)},o=t=>{if(this.mode===b)return;const{mouse:e}=this;if(!e.down)return;const i=t.changedTouches&&t.changedTouches[0]||t,s=i.offsetX,o=i.offsetY;if(e.down=!1,e.x===s&&e.y===o&&A.includes(this.mode)){const{x:t,y:i}=this.draw(e.x,e.y,e.previous.x,e.previous.y);e.previous.set(t,i)}this.endStroke(e.x,e.y)};this.canvas.addEventListener("mousemove",i),this.canvas.addEventListener("mousedown",s),document.addEventListener("mouseup",o),this.canvas.addEventListener("touchstart",s),this.canvas.addEventListener("touchend",o),this.canvas.addEventListener("touchmove",i),this.destroy=()=>{this.clear(),this.canvas.removeEventListener("mousemove",i),this.canvas.removeEventListener("mousedown",s),document.removeEventListener("mouseup",o),this.canvas.removeEventListener("touchstart",s),this.canvas.removeEventListener("touchend",o),this.canvas.removeEventListener("touchmove",i)},this.context=this.canvas.getContext("2d"),this.context.globalCompositeOperation="source-over",this.context.globalAlpha=1,this.context.strokeStyle=e.color||"rgba(0,0,0,1)",this.context.lineCap="round",this.context.lineJoin="round",this.context.translate(.5,.5),this._filling=!1,this._fillStack=[],this.recordStrokes=!1,this.strokeMemory=[],this.smoothing=c.initialSmoothingFactor,this._thickness=c.initialThickness,this._targetThickness=this._thickness,this._weight=this._thickness,this._maxWeight=this._thickness+c.weightSpread,this._mode=v,this.adaptiveStroke=!0,["weight","smoothing","adaptiveStroke","mode"].forEach(t=>void 0===e[t]?0:this[t]=e[t])}beginStroke(t,e){this.context.beginPath(),this.context.moveTo(t,e),this.recordStrokes&&this.strokeMemory.push(new m(t,e)),this.dispatchEvent("strokestart",{x:t,y:e})}endStroke(t,e){if(this.context.closePath(),this.recordStrokes&&this.strokeMemory.push(new m(t,e)),this.dispatchEvent("strokeend",{x:t,y:e}),this.recordStrokes){const t={points:this.strokeMemory.slice(),mode:this.mode,weight:this.weight,smoothing:this.smoothing,color:this.color,adaptiveStroke:this.adaptiveStroke};this.dispatchEvent("strokerecorded",{stroke:t})}this.strokeMemory=[]}draw(t,e,i,s){this.recordStrokes&&this.strokeMemory.push(new m(t,e));const{context:o}=this,n=p.lineDistance(t,e,i,s),r=Math.min(c.minSmoothingFactor,this.smoothing+(n-60)/3e3),a=t-(t-i)*r,l=e-(e-s)*r,h=p.lineDistance(a,l,i,s);return this.adaptiveStroke?(this._targetThickness=(h-c.minLineThickness)/c.lineThicknessRange*(this._maxWeight-this._weight)+this._weight,this._thickness>this._targetThickness?this._thickness-=c.thicknessIncrement:this._thickness<this._targetThickness&&(this._thickness+=c.thicknessIncrement),o.lineWidth=this._thickness):o.lineWidth=this._weight,o.quadraticCurveTo(i,s,a,l),o.stroke(),{x:a,y:l}}get color(){return this.context.strokeStyle}set color(t){if("string"!=typeof t)throw new Error("wrong argument type");this.context.strokeStyle=t}get weight(){return this._weight}set weight(t){if("number"!=typeof t)throw new Error("wrong argument type");this._weight=t,this._thickness=t,this._targetThickness=t,this._maxWeight=t+c.weightSpread}get mode(){return this._mode}set mode(t){if("string"!=typeof t)throw new Error("wrong argument type");switch(t){case y:this._mode=y,this.context.globalCompositeOperation="destination-out";break;case b:this._mode=b,this.context.globalCompositeOperation="source-over";break;case w:this._mode=w;break;default:this._mode=v,this.context.globalCompositeOperation="source-over"}}isDirty(){return!!this._dirty}fireDirty(){this.dispatchEvent("dirty")}clear(){this.isDirty&&(this._dirty=!1,this.dispatchEvent("clean"),this.mode===y?(this.mode=v,this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20),this.mode=y):this.context.clearRect(-10,-10,this.canvas.width+20,this.canvas.height+20))}toImage(){return this.canvas.toDataURL()}fill(){const{mouse:t}=this,{context:e}=this,i=Array.from(e.getImageData(t.x,t.y,1,1).data);if(this._filling)this._fillStack.push([t.x,t.y,i]);else{const{x:e,y:s}=t;this.dispatchEvent("fillstart",{x:e,y:s}),this._filling=!0,setTimeout(()=>{this._floodFill(t.x,t.y,i)},c.floodFillInterval)}}_floodFill(t,e,i){const{context:s}=this,o=Math.floor(t),n=Math.floor(e),r=s.canvas.width,a=s.canvas.height,l=[[o,n]],h=p.hexToRgb(this.color),c=s.getImageData(0,0,s.canvas.width,s.canvas.height),u=Math.min(10*s.globalAlpha*255,255),d=p.colorPixel(c.data,...h,i,u),g=p.matchColor(c.data,...i);if(p.matchColor(c.data,...h,255)(4*(n*s.canvas.width+o)))return this._filling=!1,void this.dispatchEvent("fillend",{});for(;l.length;){const t=l.pop(),e=t[0];let i=t[1],s=4*(i*r+e);for(;i-- >=0&&g(s);)s-=4*r;s+=4*r,++i;let o=!1,n=!1;for(;i++<a-1&&g(s);)d(s),e>0&&(g(s-4)?o||(l.push([e-1,i]),o=!0):o&&(o=!1)),e<r-1&&(g(s+4)?n||(l.push([e+1,i]),n=!0):n&&(n=!1)),s+=4*r}s.putImageData(c,0,0),this._fillStack.length?this._floodFill(...this._fillStack.shift()):(this._filling=!1,this.dispatchEvent("fillend",{}))}};function S(t,e,n,r,a){this.generateActionList=function(){console.log("debug generateactionlist",this.name);let t=[];return this.queryAll("slip-slip[enter-at]").forEach(e=>{console.log("new slip with ",e,null,null,r,{}),t[e.getAttribute("enter-at")]=new S(e,"",[],r,{})}),t},this.addSubSlips=function(){console.log("debug generateactionlist",this.name);return this.queryAll("slip-slip[enter-at]").forEach(t=>{console.log("new slip with ",t,null,null,r,{}),this.setNthAction(t.getAttribute("enter-at"),new S(t,"",[],r,{}))}),[]};let l=n;this.setAction=t=>{l=t},this.getActionList=()=>{let t=[];for(let e=0;e<=this.getMaxNext();e++)this.pauseSlipList[e]instanceof S?t[e]=this.pauseSlipList[e]:"function"==typeof l[e]||l[e]instanceof S?t[e]=l[e]:t[e]=()=>{};return t},this.setNthAction=(t,e)=>{l[t]=e},this.getCurrentSubSlip=()=>l[this.getActionIndex()]instanceof S?l[this.getActionIndex()]:this.pauseSlipList[this.getActionIndex()]instanceof S&&this.pauseSlipList[this.getActionIndex()],this.nextStageNeedGoto=()=>!(l[this.getActionIndex()+1]instanceof S)&&(!(this.pauseSlipList[this.getActionIndex()+1]instanceof S)&&!(this.getActionIndex()>=this.getMaxNext())),this.getSubSlipList=function(){return this.getActionList().filter(t=>t instanceof S)};let h=-1;this.setActionIndex=t=>h=t,this.getActionIndex=()=>h,this.getMaxNext=()=>{if(this.maxNext)return this.maxNext;let t=l.length;["mk-visible-at","mk-hidden-at","mk-emphasize-at","mk-unemphasize-at","emphasize-at","chg-visib-at","up-at","down-at","center-at","static-at","exec-at","enter-at","focus-at","unfocus-at","figure-next-at","figure-previous-at"].forEach(e=>{this.queryAll("*["+e+"]").forEach(i=>{i.getAttribute(e).split(" ").forEach(e=>{t=Math.max(Math.abs(parseInt(e)),t)})})});let e=this.queryAll("[pause], [step], [auto-enter], [immediate-enter]").map(t=>t.hasAttribute("pause")&&""!=t.getAttribute("pause")?parseInt(t.getAttribute("pause")):t.hasAttribute("step")&&""!=t.getAttribute("step")?parseInt(t.getAttribute("step")):1);return t=Math.max(t,e.reduce((t,e)=>t+e,0)),this.maxNext=t,t},this.queryAll=t=>i(this.element,t),this.query=t=>"string"!=typeof t?t:this.queryAll(t)[0],this.findSubslipByID=t=>{let e=this.getSubSlipList().find(e=>e.name==t?1:e.findSubslipByID(t));return!!e&&(e.name==t?e:e.findSubslipByID(t))},this.findSlipCoordinate=()=>{let t=c.getCoordinateInUniverse(this.element);return console.log("debug findslipcoordinate",t),t.scale*=this.scale,t.y=t.y+.5*t.scale,t.x=t.centerX,console.log("debug findslipcoordinate",t),t},this.updatePauseAncestors=()=>{this.queryAll(".pauseAncestor").forEach(t=>{t.classList.remove("pauseAncestor")});let t=this.query("[pause]");for(;t&&"SLIP-SLIP"!=t.tagName;)t.classList.add("pauseAncestor"),t=t.parentElement},this.unpause=t=>{if(t.hasAttribute("static-at-unpause")&&(""==t.getAttribute("static-at-unpause")?this.makeStatic(t):t.getAttribute("static-at-unpause").split(" ").map(t=>{this.makeStatic("#"+t)})),t.hasAttribute("unstatic-at-unpause")&&(""==t.getAttribute("unstatic-at-unpause")?this.makeUnStatic(t):t.getAttribute("unstatic-at-unpause").split(" ").map(t=>{this.makeUnStatic("#"+t)})),t.hasAttribute("down-at-unpause")&&(""==t.getAttribute("down-at-unpause")?this.moveDownTo(t,1):this.moveDownTo("#"+t.getAttribute("down-at-unpause"),1)),t.hasAttribute("up-at-unpause")&&(""==t.getAttribute("up-at-unpause")?this.moveUpTo(t,1):this.moveUpTo("#"+t.getAttribute("up-at-unpause"),1)),t.hasAttribute("center-at-unpause")&&(""==t.getAttribute("center-at-unpause")?this.moveCenterTo(t,1):this.moveCenterTo("#"+t.getAttribute("center-at-unpause"),1)),t.hasAttribute("exec-at-unpause")&&(""==t.getAttribute("exec-at-unpause")?this.executeScript(t):t.getAttribute("exec-at-unpause").split(" ").map(t=>{this.executeScript("#"+t)})),t.hasAttribute("reveal-at-unpause")&&(""==t.getAttribute("reveal-at-unpause")?this.reveal(t):t.getAttribute("reveal-at-unpause").split(" ").map(t=>{this.reveal("#"+t)})),t.hasAttribute("hide-at-unpause")&&(""==t.getAttribute("hide-at-unpause")?this.hide(t):t.getAttribute("hide-at-unpause").split(" ").map(t=>{this.hide("#"+t)})),t.hasAttribute("figure-set-at-unpause")){let[e,i]=t.getAttribute("figure-set-at-unpause").split(" ");this.query("#"+e).figureStep=i}t.hasAttribute("figure-next-at-unpause")&&t.getAttribute("figure-next-at-unpause").split(" ").map(t=>{this.query("#"+t).figureStep++}),t.hasAttribute("figure-previous-at-unpause")&&t.getAttribute("figure-previous-at-unpause").split(" ").map(t=>{this.query("#"+t).figureStep--}),t.hasAttribute("focus-at-unpause")&&(""==t.getAttribute("focus-at-unpause")?this.focus(t):this.focus("#"+t.getAttribute("focus-at-unpause"))),t.hasAttribute("unfocus-at-unpause")&&(""==t.getAttribute("unfocus-at-unpause")?this.unfocus(t):this.unfocus("#"+t.getAttribute("unfocus-at-unpause")))},this.incrPause=()=>{let t=this.query('[pause], [auto-enter]:not([auto-enter="0"]), [immediate-enter]:not([immediate-enter="0"]), [step]');if(t){if(console.log("pause is",this.name,t),t.hasAttribute("step")){t.getAttribute("step")||t.setAttribute("step",1);let e=t.getAttribute("step");e<=1?(t.removeAttribute("step"),this.unpause(t)):t.setAttribute("step",e-1)}if(t.hasAttribute("auto-enter")&&(t.setAttribute("auto-enter",0),this.unpause(t)),t.hasAttribute("immediate-enter")&&(t.setAttribute("immediate-enter",0),this.unpause(t)),t.hasAttribute("pause")){t.getAttribute("pause")||t.setAttribute("pause",1);let e=t.getAttribute("pause");e<=1?(t.removeAttribute("pause"),this.unpause(t)):t.setAttribute("pause",e-1),this.updatePauseAncestors()}}},this.doAttributes=()=>{this.queryAll("*[mk-hidden-at]").forEach(t=>{t.getAttribute("mk-hidden-at").split(" ").map(t=>parseInt(t)).includes(h)&&(t.style.opacity="0")}),this.queryAll("*[mk-visible-at]").forEach(t=>{t.getAttribute("mk-visible-at").split(" ").map(t=>parseInt(t)).includes(h)&&(t.style.opacity="1")}),this.queryAll("*[mk-emphasize-at]").forEach(t=>{t.getAttribute("mk-emphasize-at").split(" ").map(t=>parseInt(t)).includes(h)&&t.classList.add("emphasize")}),this.queryAll("*[mk-unemphasize-at]").forEach(t=>{t.getAttribute("mk-unemphasize-at").split(" ").map(t=>parseInt(t)).includes(h)&&t.classList.remove("emphasize")}),this.queryAll("*[emphasize-at]").forEach(t=>{t.getAttribute("emphasize-at").split(" ").map(t=>parseInt(t)).includes(h)?t.classList.add("emphasize"):t.classList.remove("emphasize")}),this.queryAll("*[chg-visib-at]").forEach(t=>{let e=t.getAttribute("chg-visib-at").split(" ").map(t=>parseInt(t));e.includes(h)&&(t.style.opacity="1"),e.includes(-h)&&(t.style.opacity="0")}),this.queryAll("*[static-at]").forEach(t=>{let e=t.getAttribute("static-at").split(" ").map(t=>parseInt(t));h<0||(e.includes(-h)?(console.log("make unstatic actionIndex elem",h,t),this.makeUnStatic(t)):e.includes(h)&&this.makeStatic(t))}),this.queryAll("*[down-at]").forEach(t=>{t.getAttribute("down-at").split(" ").map(t=>parseInt(t)).includes(h)&&this.moveDownTo(t,1)}),this.queryAll("*[up-at]").forEach(t=>{t.getAttribute("up-at").split(" ").map(t=>parseInt(t)).includes(h)&&this.moveUpTo(t,1)}),this.queryAll("*[center-at]").forEach(t=>{t.getAttribute("center-at").split(" ").map(t=>parseInt(t)).includes(h)&&this.moveCenterTo(t,1)}),this.queryAll("*[focus-at]").forEach(t=>{t.getAttribute("focus-at").split(" ").map(t=>parseInt(t)).includes(h)&&this.focus(t,1)}),this.queryAll("*[unfocus-at]").forEach(t=>{t.getAttribute("unfocus-at").split(" ").map(t=>parseInt(t)).includes(h)&&this.unfocus(t,1)}),this.queryAll("*[exec-at]").forEach(t=>{t.getAttribute("exec-at").split(" ").map(t=>parseInt(t)).includes(h)&&this.executeScript(t)}),this.queryAll("*[figure-next-at]").forEach(t=>{t.getAttribute("figure-next-at").split(" ").map(t=>parseInt(t)).includes(h)&&t.figureStep++}),this.queryAll("*[figure-previous-at]").forEach(t=>{t.getAttribute("figure-previous-at").split(" ").map(t=>parseInt(t)).includes(h)&&t.figureStep--})},this.incrIndex=()=>{console.log("incrIndex",this.name),h+=1,this.doAttributes(),h>0&&this.incrPause(),this.updateToC()},this.next=function(){return!(h>=this.getMaxNext())&&(this.incrIndex(),"function"==typeof l[h]&&l[h](this),l[h]instanceof S?l[h]:!(this.pauseSlipList[h]instanceof S)||this.pauseSlipList[h])},this.previous=()=>{let t=this.getActionIndex(),e=this.currentDelay;this.getEngine().setDoNotMove(!0);let i,s=this.doRefresh();if(console.log("gotoslip: we call doRefresh",s),-1==t)return!1;for(;this.getActionIndex()<t-1;)console.log("previous is ca we do next",this.getEngine().getDoNotMove()),console.log("(figure) actionIndex is",h),i=this.next();return setTimeout(()=>{this.getEngine().setDoNotMove(!1)},0),this.getEngine().gotoSlip(this,{delay:e}),i},this.setTocElem=t=>{this.tocElem=t},this.updateToC=()=>{if(!this.tocElem)return;let t;for(this.ToCList||(this.ToCList=i(this.tocElem,"li","li")),t=0;t<this.getActionIndex();t++)this.ToCList[t].classList.remove("before","after","current"),this.ToCList[t].classList.add("before");for(t<=this.getActionIndex()&&(this.ToCList[t].classList.remove("before","after","current"),this.ToCList[t].classList.add("current"),t++);t<=this.getMaxNext();t++)this.ToCList[t].classList.remove("before","after","current"),this.ToCList[t].classList.add("after")},this.firstVisit=()=>{this.updateToC(),a.firstVisit&&a.firstVisit(this)},this.init=()=>{this.queryAll("*[chg-visib-at]").forEach(t=>{t.style.opacity="0"}),this.updatePauseAncestors(),a.init&&a.init(this)},this.refresh=()=>{l[h]instanceof S?l[h].refresh():this.doRefresh()},this.refreshAll=()=>{l.filter(t=>t instanceof S).forEach(t=>{t.refreshAll()}),this.pauseSlipList.filter(t=>t instanceof S).forEach(t=>{t.refreshAll()}),this.doRefresh()},this.doRefresh=()=>{console.log("to Atrament debug",this.element),console.log("gotoslip: doRefresh has been called"),this.setActionIndex(-1);let t=i(this.element,"slip-slip");console.log("mmdebug",d),console.log("to Atrament debug clonedElement",d);let e=d.cloneNode(!0);o(e,t,this.sketchpadCanvas),this.element.replaceWith(e),this.element=e,this.init(),this.firstVisit(),delete this.currentX,delete this.currentY,delete this.currentDelay,console.log("previous is ca GOTOSLIP FROM 3",a,this.getEngine().getDoNotMove()),this.getEngine().gotoSlip(this)},this.makeUnStatic=(t,e,i)=>{let s=this.query(t);s.style.position="absolute",s.style.visibility="hidden"},this.makeStatic=t=>{let e=this.query(t);e.style.position="static",e.style.visibility="visible"},this.unfocus=t=>{this.getEngine().gotoSlip(this,{delay:1})},this.focus=t=>{let e=this.query(t);this.getEngine().moveToElement(e,{})},this.executeScript=t=>{let e;e="string"==typeof t?this.query(t):t,new Function("slip",e.innerHTML)(this)},this.moveUpTo=(t,e,i)=>{setTimeout(()=>{let s;s="string"==typeof t?this.query(t):t,void 0===i&&(i=.0125);let o=this.findSlipCoordinate(),n=(s.offsetTop/1080-i)*o.scale;this.moveWindow(o.x,o.y+n,o.scale,this.rotate,e)},0)},this.moveDownTo=(t,e,i)=>{setTimeout(()=>{let s;s="string"==typeof t?this.query(t):t,void 0===i&&(i=.0125);let o=this.findSlipCoordinate(),n=((s.offsetTop+s.offsetHeight)/1080-1+i)*o.scale;this.moveWindow(o.x,o.y+n,o.scale,this.rotate,e)},0)},this.moveCenterTo=(t,e,i)=>{setTimeout(()=>{let s;s="string"==typeof t?this.query(t):t,void 0===i&&(i=0);let o=this.findSlipCoordinate(),n=((s.offsetTop+s.offsetHeight/2)/1080-.5+i)*o.scale;this.moveWindow(o.x,o.y+n,o.scale,this.rotate,e)},0)},this.restoreWindow=()=>{this.getEngine},this.moveWindow=(t,e,i,s,o)=>{this.currentX=t,this.currentY=e,this.currentDelay=o,console.log("previous is ca we try to move win",this.getEngine().getDoNotMove()),console.log("previous is ca ORIGIN 3",t,e,this.getEngine().getDoNotMove()),this.getEngine().moveWindow(t,e,i,s,o)},this.reveal=t=>{let e;e="string"==typeof t?this.query(t):t,e.style.opacity="1"},this.revealAll=t=>{this.queryAll(t).forEach(t=>{t.style.opacity="1"})},this.hide=t=>{this.query(t).style.opacity="0"},this.hideAll=t=>{this.queryAll(t).forEach(t=>{t.style.opacity="0"})},this.setTool=t=>{this.element.classList.remove("drawing","highlighting"),"highlighting"==t?(this.element.classList.add("highlighting"),this.sketchpadHighlight.mode="draw"):"highlighting-erase"==t?(this.element.classList.add("highlighting"),this.sketchpadHighlight.mode="erase"):"drawing"==t?(this.element.classList.add("drawing"),this.sketchpad.mode="draw",this.sketchpad.weight=2):"drawing-erase"==t&&(this.element.classList.add("drawing"),this.sketchpad.weight=20,this.sketchpad.mode="erase")};let c=r;this.getEngine=()=>c,this.setEngine=t=>c=t,this.element="string"==typeof t?document.querySelector("#"==t[0]?t:"#"+t):t;var u=this;console.log("element bug before",this.element,u.element);let d,p=this.element;setTimeout((function(){let t=document.createElement("canvas");t.height=p.offsetHeight,t.width=p.offsetWidth,console.log("element bug after",p,u.element),t.classList.add("sketchpad","drawing"),t.style.opacity="1",u.sketchpadCanvas=t,p.firstChild.firstChild.appendChild(t),u.sketchpad=new x(t),u.sketchpad.smoothing=.2,u.sketchpad.color="blue";let e=document.createElement("canvas");e.height=u.element.offsetHeight,e.width=u.element.offsetWidth,e.classList.add("sketchpad","sketchpad-highlighting"),e.style.opacity="0.5",u.sketchpadCanvasHighlight=e,p.firstChild.firstChild.appendChild(e),u.sketchpadHighlight=new x(e),u.sketchpadHighlight.color="yellow",u.sketchpadHighlight.weight=30,u.sketchpadHighlight.smoothing=.2}),0),this.name="string"==typeof t?t:t.id,"string"==typeof e?this.fullName=e:this.element.hasAttribute("toc-title")?this.fullName=this.element.getAttribute("toc-title"):this.fullName=this.name,console.log("this name is ",this.name),"undefined"!=typeof MathJax?MathJax.startup.promise.then(()=>{setTimeout(()=>{d=s(this.element)},0)}):setTimeout(()=>{d=s(this.element)},0),console.log("to Atrament debug before",this.element),this.getCloned=()=>d,this.setCloned=t=>d=t,this.scale=parseFloat(this.element.getAttribute("scale")),(void 0===this.scale||isNaN(this.scale))&&(this.scale=1),this.rotate=parseFloat(this.element.getAttribute("rotate"))||0,this.delay=isNaN(parseFloat(this.element.getAttribute("delay")))?0:parseFloat(this.element.getAttribute("delay"));let g=this.findSlipCoordinate();console.log(g),this.x=g.x,this.y=g.y,this.init(this,c),this.addSubSlips(),this.generatePauseFlowSlipList=function(){let t=[],e=this.queryAll("[pause], [step], [auto-enter], [immediate-enter]"),i=1;return e.forEach(e=>{if(console.log("debug generatePauseFlowsliplist",e,i),e.hasAttribute("auto-enter")&&(t[i]=new S(e,e.getAttribute("toc-title")||"",[],r,{}),i++),e.hasAttribute("immediate-enter")&&(t[i-1]=new S(e,e.getAttribute("toc-title")||"",[],r,{}),i++),e.hasAttribute("step")){if(console.log("has enter-at-unpause?"),e.hasAttribute("enter-at-unpause"))if(console.log("has enter-at-unpause"),""!=e.getAttribute("enter-at-unpause")){let s=this.query("#"+e.getAttribute("enter-at-unpause"));t[i]=new S(s,s.getAttribute("toc-title")||"",[],r,{})}else t[i+(parseInt(e.getAttribute("step"))||1)-1]=new S(e,e.getAttribute("toc-title")||"",[],r,{});console.log("debug generatePauseFlowsliplist1",e,i),i+=parseInt(e.getAttribute("step"))||1,console.log("debug generatePauseFlowsliplist2",e,i)}if(e.hasAttribute("pause")){if(e.hasAttribute("enter-at-unpause"))if(""!=e.getAttribute("enter-at-unpause")){let s=this.query(e.getAttribute("enter-at-unpause"));t[i+(parseInt(e.getAttribute("step"))||1)-1]=new S(s,s.getAttribute("toc-title")||"",[],r,{})}else t[i+(parseInt(e.getAttribute("step"))||1)-1]=new S(e,e.getAttribute("toc-title")||"",[],r,{});console.log("debug generatePauseFlowsliplist1",e,i),i+=parseInt(e.getAttribute("pause"))||1,console.log("debug generatePauseFlowsliplist1",e,i)}}),t},this.pauseSlipList=this.generatePauseFlowSlipList()}const k=function(t){"string"==typeof t?("#"!=t[0]&&(t="#"+t),t=document.querySelector(t)):void 0===t&&(t=document.querySelector("slip-slipshow")),function(t){let e=document.createElement("div");e.innerHTML='\t\t<div class="toc-slip" style="display:none;"></div>        <div id="open-window">\t  <div class="cpt-slip">0</div>\t  <div class="format-container">\t    <div class="rotate-container">\t\t<div class="scale-container">\t\t    <div class="universe movable" id="universe">\t\t\t<div width="10000" height="10000" class="fog"></div>                        <div class="placeHolder"></div>\t\t    </div>\t\t</div>              </div>\t    </div>\t</div>',t.replaceWith(e),e.querySelector(".placeHolder").replaceWith(t),t.querySelectorAll("slip-slip").forEach(t=>{setTimeout(()=>{var e=document.createElement("div"),i=document.createElement("div");let s;for(e.classList.add("slip-scale-container"),i.classList.add("slip-container");s=t.firstChild;)i.appendChild(s);e.appendChild(i),t.appendChild(e),setTimeout(()=>{},0)},0)}),t.style.width="unset",t.style.height="unset",document.querySelectorAll(".background-canvas").forEach(t=>{t.addEventListener("click",t=>{console.log("vous avez cliquez aux coordonnées : ",t.layerX,t.layerY)})})}(t),document.body.style.cursor="auto";let e=[];document.body.addEventListener("mousemove",t=>{e.forEach(t=>{clearTimeout(t)}),document.body.style.cursor="auto",e.push(setTimeout(()=>{document.body.style.cursor="none"},5e3))});let s,o,n,a,l,h,c,u,d=document.querySelector("#open-window"),p=document.querySelector("#universe"),g=p.querySelectorAll("slip-slip:not(slip-slipshow)");this.getOpenWindowHeight=()=>a,this.getOpenWindowWidth=()=>o,this.getCoord=()=>({x:l,y:h,scale:c});let m=!1;function f(t,e){if(1==e||e>3)return t.toString();let i,s="",o=[1e3,900,500,400,100,90,50,40,10,9,5,4,1];i=0==e?["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]:["m","cm","d","cd","c","xc","l","xl","x","ix","v","iv","i"];for(var n=0;n<=o.length;n++)for(;t%o[n]<t;)s+=i[n],t-=o[n];return s}this.setDoNotMove=t=>m=t,this.getDoNotMove=t=>m,this.moveWindow=function(t,e,i,s,o){if(this.getDoNotMove())return console.log("we cannot move"),void console.log("previous is ca we cannot move !");console.log("previous is ca getDoNotMove !",t,e,i,s,o,this.getDoNotMove()),console.log("move to",t,e,"with scale, rotate, delay",i,s,o),c=i,u=s,l=t,h=e,console.log(t,e),setTimeout(()=>{document.querySelector(".scale-container").style.transitionDuration=o+"s",document.querySelector(".rotate-container").style.transitionDuration=o+"s",p.style.transitionDuration=o+"s, "+o+"s",setTimeout(()=>{p.style.left=-(1440*t-720)+"px",p.style.top=-(1080*e-540)+"px",document.querySelector(".scale-container").style.transform="scale("+1/i+")",document.querySelector(".rotate-container").style.transform="rotate("+s+"deg)"},0)},0)},this.moveWindowRelative=function(t,e,i,s,o){this.moveWindow(l+t,h+e,c+i,u+s,o)},this.placeSlip=function(t){let e=parseFloat(t.getAttribute("scale")),i=t.querySelector(".slip-scale-container");e=isNaN(e)?1:e,i.style.transform="scale("+e+")",t.style.width=Math.max(i.offsetWidth,1440)*e+"px",t.style.height=Math.max(i.offsetHeight,1080)*e+"px"},this.placeSlips=function(){let t=function t(e){console.log("debug depth (elem)",e);let s=i(e,"slip-slip");return console.log("debug depth (subslips)",e),1+s.map(t).reduce((t,e)=>Math.max(t,e),0)}(document.body);console.log("debug",t);for(let e=0;e<t;e++)g.forEach(this.placeSlip)},setTimeout(()=>{this.placeSlips()},0),this.placeOpenWindow=function(){s=window.innerHeight,n=window.innerWidth,s/3<n/4?(o=Math.floor(4*s/3),a=s,d.style.left=(window.innerWidth-o)/2+"px",d.style.right=(window.innerWidth-o)/2+"px",d.style.width=o+"px",d.style.top="0",d.style.bottom="0",d.style.height=a+"px"):(a=Math.floor(3*n/4),o=n,d.style.top=(window.innerHeight-a)/2+"px",d.style.bottom=(window.innerHeight-a)/2+"px",d.style.height=a+"px",d.style.right="0",d.style.left="0",d.style.width=o+"px"),document.querySelector(".scale-container").style.transformOrigin="720px 540px",document.querySelector(".rotate-container").style.transformOrigin="720px 540px",document.querySelector(".format-container").style.transform="scale("+o/1440+")",document.querySelector(".cpt-slip").style.right=parseInt(d.style.left)+"px",document.querySelector(".cpt-slip").style.bottom="0",document.querySelector(".cpt-slip").style.zIndex="10"},this.placeOpenWindow(),window.addEventListener("resize",t=>{this.placeOpenWindow(),this.moveWindow(l,h,c,u,0)}),this.countersToString=t=>{let e="";e+=f(t[0]+1,0);for(let i=1;i<t.length;i++)e+="."+f(t[i]+1,i);return e},this.updateCounter=function(){let t=b.map(t=>t.getActionIndex());document.querySelector(".cpt-slip").innerHTML=this.countersToString(t)},this.enter=t=>{this.gotoSlip(t),this.push(t),this.next()},this.next=()=>{""==document.querySelector(".toc-slip").innerHTML&&this.showToC();let t=this.getCurrentSlip().next();if(this.updateCounter(),t instanceof S)return this.enter(t),!0;if(!t){this.pop();let t=this.getCurrentSlip();return t.nextStageNeedGoto()&&this.gotoSlip(t),b.length>1||t.getActionIndex()<t.getMaxNext()?this.next():this.gotoSlip(t),!0}return!1},this.nextSlip=function(){for(;!this.next(););},this.previous=t=>{console.log("previous is called with option",t);let e=this.getCurrentSlip(),i=e.previous();if(console.log("debug previous (currentSlip, n)",e,i),i instanceof S){for(;i.getCurrentSubSlip()instanceof S;)this.push(i),i=i.getCurrentSubSlip();return this.push(i),console.log("previous is ca GOTOSLIP FROM 1",t),this.gotoSlip(i,t),this.updateCounter(),!0}if(!i){this.pop();let i=this.getCurrentSlip();return console.log("previous is ca currentDelay, delay",e.currentDelay,e.delay),b.length>1||i.getActionIndex()>-1?this.previous({delay:e.currentDelay?e.currentDelay:e.delay}):(this.gotoSlip(i,t),console.log("previous is ca GOTOSLIP FROM 2",t)),this.updateCounter(),!0}return t&&setTimeout(()=>{this.gotoSlip(e,t)},0),this.updateCounter(),!1},this.previousSlip=function(){for(;!this.previous(););},this.getCoordinateInUniverse=function(t){console.log("debug getcoord elem",t);let e=1,i=function(t){return"none"==t?1:parseFloat(t.split("(")[1].split(",")[0])},s=t=>{console.log("debug getcoorditer elem",t);let o=(t=>({x:t.offsetLeft,y:t.offsetTop}))(t);if(!t.offsetParent)return{x:0,y:0,centerX:0,centerY:0,width:0,height:0,scale:0};if(t.offsetParent.classList.contains("universe"))return console.log("universe",o),o;let n,r=s(t.offsetParent),a=window.getComputedStyle(t.offsetParent);return n=i(a.transform),e*=n,{x:r.x+o.x*e,y:r.y+o.y*e}},o=s(t),n=window.getComputedStyle(t),r=i(n.transform);e*=r,console.log("getCoord",{x:o.x/1440+.5,y:o.y/1080+.5},"globalScale",e,n.transform,r);let a={x:o.x/1440,y:o.y/1080,centerX:o.x/1440+.5*t.offsetWidth/1440*e,centerY:o.y/1080+.5*t.offsetHeight/1080*e,width:t.offsetWidth/1440*e,height:t.offsetHeight/1080*e,scale:e};return console.log(a),a},this.moveToElement=function(t,e){let i=this.getCoordinateInUniverse(t);t.offsetWidth,i.scale,t.offsetHeight,i.scale;e&&this.moveWindow(i.centerX,i.centerY,Math.max(i.width,i.height),0,e.delay?e.delay:1)},this.gotoSlip=function(t,e){console.log("previous is ca goto slip",e,t.element,this.getDoNotMove()),console.log("we goto slip",t.element,this.getDoNotMove()),e=e||{},console.log("options is ",e),"SLIP-SLIP"==t.element.tagName?setTimeout(()=>{let i=t.findSlipCoordinate();void 0!==t.currentX&&void 0!==t.currentY?(console.log("previous is ca ORIGIN 1",t.currentX,t.currentY,this.getDoNotMove(),e),this.moveWindow(t.currentX,t.currentY,i.scale,t.rotate,void 0!==e.delay?e.delay:void 0!==t.currentDelay?t.currentDelay:t.delay)):(t.currentX=i.x,t.currentY=i.y,t.currentDelay=t.delay,console.log("previous is ca ORIGIN 2",i.x,i.y,this.getDoNotMove()),this.moveWindow(i.x,i.y,i.scale,t.rotate,void 0!==e.delay?e.delay:void 0!==t.currentDelay?t.currentDelay:t.delay))},0):setTimeout(()=>{console.log("debug slip element",t.element);let i=this.getCoordinateInUniverse(t.element);this.moveWindow(i.centerX,i.centerY,Math.max(i.width,i.height),0,void 0!==e.delay?e.delay:t.delay)},0)};let v,y=new S(t,"Presentation",[],this,{}),b=[y];this.push=function(t){this.getToC().querySelectorAll(".toc-slip .active-slip").forEach(t=>t.classList.remove("active-slip")),t.tocElem&&t.tocElem.classList.add("active-slip"),t.element.classList.add("active-true-slip"),b.length>0&&b[b.length-1].element.classList.remove("active-true-slip"),b.push(t)},this.pop=function(){this.getToC().querySelectorAll(".toc-slip .active-slip").forEach(t=>t.classList.remove("active-slip"));let t=b.pop();return t.element.classList.remove("active-true-slip"),0==b.length&&b.push(t),b[b.length-1].element.classList.add("active-true-slip"),b[b.length-1].tocElem&&b[b.length-1].tocElem.classList.add("active-slip"),t},this.getCurrentSlip=function(){return b[b.length-1]},this.getSlipTree=function(t){return(t=t||y)instanceof S?{name:t.name,slip:t,subslips:t.getActionList().map(t=>this.getSlipTree(t))}:{function:!0}},this.goToState=function(t){let e=t=>{if(0!=t.length)for(e(t[0]);t[1].getActionIndex()<t[2];)this.next()};b=[y],y.refreshAll(),e(t),this.gotoSlip(t[1])},this.getToC=function(){return v||(v=document.querySelector(".toc-slip"),v)},this.showToC=function(){console.log("debug showtoc");let t=document.querySelector(".toc-slip"),e=(document.createElement("div"),this.getSlipTree()),i=(t,e)=>{console.log("debug treee",t);let s=document.createElement("div"),o=document.createElement("div");if(o.innerText=t.slip.fullName,s.appendChild(o),t.subslips.length>0){let o=document.createElement("ul");t.subslips.forEach((s,n)=>{let r=[e,t.slip,n],a=document.createElement("li");if(s.function){let t=e=>0==e.length?[]:t(e[0]).concat([e[2]]);a.innerText=this.countersToString(t(r)),a.classList.add("toc-function")}else a.appendChild(i(s,r));a.addEventListener("click",t=>{t.target==a&&(this.goToState(r),console.log("newstack",r))}),o.appendChild(a)}),s.appendChild(o),t.slip.setTocElem(s)}return console.log("debug tree, will return",s),s};t.innerHTML="",t.appendChild(i(e,[]))},this.setTool=t=>{this.getCurrentSlip().setTool(t)},this.setRootSlip=t=>{y=t,b=[y]},this.getRootSlip=()=>y,this.start=()=>(b=[y],this.next(),this),this.restart=()=>{b=[y],y.refreshAll(),this.next()};let w=new r(this);this.getController=()=>w},E=r,L=S,T=n;return t.Controller=E,t.Engine=k,t.Slip=L,t.Util=T,t.startSlipshow=()=>{let t;return"undefined"!=typeof MathJax?MathJax.startup.promise.then(()=>{t=new k(document.querySelector("slip-slipshow")).start()}):t=new k(document.querySelector("slip-slipshow")).start(),t},t}({});
//# sourceMappingURL=slipshow.cdn.min.js.map
